{% extends "dashboard_base.html" %}

{% block page_title %}User Management{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1>User Management</h1>
        <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New User
        </a>
    </div>
    
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ (user.first_name or '') + ' ' + (user.last_name or '') if user.first_name or user.last_name else 'N/A' }}</td>
                    <td>{{ user.email or 'N/A' }}</td>
                    <td>{{ user.role }}</td>
                    <td><span class="status-badge status-{{ 'active' if user.is_active else 'inactive' }}">{{ 'Active' if user.is_active else 'Inactive' }}</span></td>
                    <td>{{ user.created_at }}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editUser('{{ user.id }}')">Edit</button>
                        {% if user.is_active %}
                        <button class="btn btn-sm btn-danger" onclick="toggleUserStatus('{{ user.id }}', false)">Deactivate</button>
                        {% else %}
                        <button class="btn btn-sm btn-success" onclick="toggleUserStatus('{{ user.id }}', true)">Activate</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
async function editUser(userId) {
    // Get user data and show edit modal/form
    const userRow = event.target.closest('tr');
    const userName = userRow.querySelector('td:nth-child(1)').textContent;
    const userEmail = userRow.querySelector('td:nth-child(2)').textContent;
    const userRole = userRow.querySelector('td:nth-child(3)').textContent;
    
    const newName = prompt('Enter new full name:', userName);
    if (!newName) return;
    
    const newRole = prompt('Enter new role (student/teacher/counselor/admin):', userRole);
    if (!newRole) return;
    
    try {
        const response = await fetch('/admin/users/' + userId, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                full_name: newName,
                role: newRole,
                is_active: true
            })
        });
        
        const data = await response.json();
        if (data.success) {
            if (typeof showToast === 'function') {
                showToast('User updated successfully!', 'success');
            } else {
                Toastify({
                    text: 'User updated successfully!',
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#34C38F",
                }).showToast();
            }
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        if (typeof showToast === 'function') {
            showToast('An error occurred', 'error');
        }
    }
}

async function toggleUserStatus(userId, activate) {
    const action = activate ? 'activate' : 'deactivate';
    const message = activate ? 'Are you sure you want to activate this user?' : 'Are you sure you want to deactivate this user?';
    
    if (confirm(message)) {
        try {
            const response = await fetch('/admin/users/' + userId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    is_active: activate
                })
            });
            
            const data = await response.json();
            if (data.success) {
                const successMessage = activate ? 'User activated successfully!' : 'User deactivated successfully!';
                if (typeof showToast === 'function') {
                    showToast(successMessage, 'success');
                } else {
                    Toastify({
                        text: successMessage,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#34C38F",
                    }).showToast();
                }
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            if (typeof showToast === 'function') {
                showToast('An error occurred', 'error');
            } else {
                Toastify({
                    text: 'An error occurred',
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#F46A6A",
                }).showToast();
            }
        }
    }
}
</script>
{% endblock %}

