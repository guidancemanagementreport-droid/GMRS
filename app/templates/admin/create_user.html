{% extends "dashboard_base.html" %}

{% block page_title %}Create User Account{% endblock %}

{% block content %}
<div class="container">
    <div class="form-card">
        <h2>Create New User Account</h2>
        <p class="text-muted">Only admins can create user accounts. A 6-digit password will be auto-generated.</p>
        
        <form id="createUserForm">
            <div class="form-group">
                <label for="full_name">Full Name *</label>
                <input type="text" id="full_name" name="full_name" required>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
                <label for="id_number">ID Number</label>
                <input type="text" id="id_number" name="id_number" placeholder="Student ID, Teacher ID, etc.">
                <small class="form-text">Leave empty to auto-generate from email</small>
            </div>
            
            <div class="form-group">
                <label for="role">Role *</label>
                <select id="role" name="role" required>
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                    <option value="counselor">Counselor</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block">Create User Account</button>
            <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary btn-block">Cancel</a>
        </form>
        
        <div id="credentialsDisplay" style="display: none; margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
            <h3>User Credentials Created</h3>
            <div class="credentials-info">
                <p><strong>Username:</strong> <span id="createdUsername" style="font-family: monospace; font-weight: bold; color: #0D1E4B;"></span></p>
                <p><strong>Email:</strong> <span id="createdEmail"></span></p>
                <p><strong>Password:</strong> <span id="createdPassword" style="font-family: monospace; font-size: 1.2rem; font-weight: bold; color: #0D1E4B;"></span></p>
            </div>
            <div style="margin-top: 1rem;">
                <button onclick="downloadCredentials()" class="btn btn-primary">Download Credentials</button>
                <button onclick="copyCredentials()" class="btn btn-secondary">Copy to Clipboard</button>
            </div>
        </div>
    </div>
</div>

<script>
let createdCredentials = null;

document.getElementById('createUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        email: document.getElementById('email').value,
        full_name: document.getElementById('full_name').value,
        role: document.getElementById('role').value,
        id_number: document.getElementById('id_number').value
    };
    
    try {
        const response = await fetch('/admin/users/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            createdCredentials = data;
            document.getElementById('createdUsername').textContent = data.username || 'N/A';
            document.getElementById('createdEmail').textContent = data.email;
            document.getElementById('createdPassword').textContent = data.password;
            document.getElementById('credentialsDisplay').style.display = 'block';
            
            // Show toast notification
            if (typeof showToast === 'function') {
                showToast('User account created successfully!', 'success');
            } else {
                Toastify({
                    text: 'User account created successfully!',
                    duration: 5000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#34C38F",
                }).showToast();
            }
            
            // Scroll to credentials
            document.getElementById('credentialsDisplay').scrollIntoView({ behavior: 'smooth' });
        } else {
            if (typeof showToast === 'function') {
                showToast(data.error || 'Failed to create user', 'error');
            } else {
                Toastify({
                    text: data.error || 'Failed to create user',
                    duration: 5000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#F44336",
                }).showToast();
            }
        }
    } catch (error) {
        if (typeof showToast === 'function') {
            showToast('An error occurred. Please try again.', 'error');
        } else {
            Toastify({
                text: 'An error occurred. Please try again.',
                duration: 5000,
                gravity: "top",
                position: "right",
                backgroundColor: "#F44336",
            }).showToast();
        }
    }
});

function downloadCredentials() {
    if (!createdCredentials) return;
    
    const content = `User Account Credentials\n\n` +
                   `Username: ${createdCredentials.username || 'N/A'}\n` +
                   `Email: ${createdCredentials.email}\n` +
                   `Password: ${createdCredentials.password}\n\n` +
                   `Please keep these credentials secure.\n` +
                   `Generated on: ${new Date().toLocaleString()}`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `credentials_${createdCredentials.email.replace('@', '_')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    if (typeof showToast === 'function') {
        showToast('Credentials downloaded', 'success');
    }
}

function copyCredentials() {
    if (!createdCredentials) return;
    
    const text = `Username: ${createdCredentials.username || 'N/A'}\nEmail: ${createdCredentials.email}\nPassword: ${createdCredentials.password}`;
    
    navigator.clipboard.writeText(text).then(() => {
        if (typeof showToast === 'function') {
            showToast('Credentials copied to clipboard', 'success');
        } else {
            Toastify({
                text: 'Credentials copied to clipboard',
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#34C38F",
            }).showToast();
        }
    });
}
</script>

<style>
.text-muted {
    color: var(--text-light);
    margin-bottom: 1.5rem;
}

.form-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: var(--text-light);
}

.credentials-info {
    margin: 1rem 0;
}

.credentials-info p {
    margin: 0.5rem 0;
    font-size: 1rem;
}
</style>
{% endblock %}

