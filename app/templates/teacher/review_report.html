{% extends "dashboard_base.html" %}

{% block page_title %}Review Report{% endblock %}

{% block content %}
<div class="container">
    <a href="{{ url_for('teacher.review_reports') }}" class="btn btn-sm" style="margin-bottom: 1rem;">
        <i class="fas fa-arrow-left"></i> Back to Reports
    </a>
    
    {% if report %}
    <div class="form-card" style="margin-bottom: 2rem;">
        <h2>Report Details</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Tracking Code</label>
                <p style="font-size: 1.125rem; font-weight: 600; color: var(--teacher-color);">{{ report.tracking_code or 'N/A' }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Student Name</label>
                <p style="font-size: 1.125rem;">
                    {% if report.users %}
                        {{ (report.users.first_name or '') + ' ' + (report.users.last_name or '') }}
                    {% else %}
                        N/A
                    {% endif %}
                </p>
            </div>
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Report Type</label>
                <p style="font-size: 1.125rem;">{{ report.report_type or 'N/A' }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Category</label>
                <p style="font-size: 1.125rem;">{{ report.category|title if report.category else 'N/A' }}</p>
            </div>
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Status</label>
                <p><span class="status-badge status-{{ report.status|lower|replace(' ', '-') }}">{{ report.status or 'N/A' }}</span></p>
            </div>
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Stage</label>
                <p><span class="badge badge-stage badge-{{ report.stage|lower|replace(' ', '-') }}">{{ report.stage or 'Teacher Review' }}</span></p>
            </div>
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Priority</label>
                <p><span class="badge badge-priority badge-{{ report.priority|lower if report.priority else 'normal' }}">{{ report.priority or 'Normal' }}</span></p>
            </div>
            <div>
                <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Date Submitted</label>
                <p style="font-size: 1.125rem;">
                    {% if report.created_at %}
                        {{ report.created_at[:10] if report.created_at|length > 10 else report.created_at }}
                    {% else %}
                        N/A
                    {% endif %}
                </p>
            </div>
        </div>
        
        <div style="margin-top: 2rem;">
            <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Subject</label>
            <p style="font-size: 1.125rem; margin-top: 0.5rem;">{{ report.subject or 'N/A' }}</p>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Description</label>
            <p style="margin-top: 0.5rem; line-height: 1.6; color: #4B5563;">{{ report.description or 'N/A' }}</p>
        </div>
        
        {% if report.incident_location %}
        <div style="margin-top: 1.5rem;">
            <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Incident Location</label>
            <p style="margin-top: 0.5rem;">{{ report.incident_location }}</p>
        </div>
        {% endif %}
        
        {% if report.incident_date %}
        <div style="margin-top: 1.5rem;">
            <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Incident Date</label>
            <p style="margin-top: 0.5rem;">{{ report.incident_date }}</p>
        </div>
        {% endif %}
        
        {% if report.persons_involved %}
        <div style="margin-top: 1.5rem;">
            <label style="font-weight: 600; color: #6B7280; font-size: 0.875rem;">Persons Involved</label>
            <p style="margin-top: 0.5rem;">{{ report.persons_involved }}</p>
        </div>
        {% endif %}
    </div>
    
    <div class="form-card">
        <h2>Teacher Review</h2>
        
        {% if review %}
        <div style="background: #F3F4F6; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <p style="font-weight: 600; margin-bottom: 0.5rem;">Previous Review ({{ review.created_at[:10] if review.created_at else 'N/A' }})</p>
            <p style="color: #4B5563; margin-bottom: 0.5rem;"><strong>Notes:</strong> {{ review.notes }}</p>
            {% if review.action_taken %}
            <p style="color: #4B5563; margin-bottom: 0.5rem;"><strong>Action Taken:</strong> {{ review.action_taken }}</p>
            {% endif %}
            {% if review.recommendation %}
            <p style="color: #4B5563;"><strong>Recommendation:</strong> {{ review.recommendation }}</p>
            {% endif %}
            <p style="margin-top: 0.5rem;"><span class="status-badge status-{{ review.status|lower|replace(' ', '-') }}">{{ review.status }}</span></p>
        </div>
        {% endif %}
        
        <form id="reviewForm">
            <div class="form-group">
                <label for="notes">Review Notes: <span style="color: red;">*</span></label>
                <textarea id="notes" name="notes" rows="6" placeholder="Enter your review comments and observations..." required>{% if review %}{{ review.notes }}{% endif %}</textarea>
            </div>
            
            <div class="form-group">
                <label for="action_taken">Action Taken:</label>
                <textarea id="action_taken" name="action_taken" rows="3" placeholder="Describe any actions you have taken regarding this report...">{% if review %}{{ review.action_taken }}{% endif %}</textarea>
            </div>
            
            <div class="form-group">
                <label for="recommendation">Recommendation:</label>
                <select id="recommendation" name="recommendation">
                    <option value="">Select recommendation...</option>
                    <option value="Forward to counselor" {% if review and review.recommendation == 'Forward to counselor' %}selected{% endif %}>Forward to Counselor</option>
                    <option value="Monitor" {% if review and review.recommendation == 'Monitor' %}selected{% endif %}>Monitor</option>
                    <option value="Resolve" {% if review and review.recommendation == 'Resolve' %}selected{% endif %}>Resolve</option>
                    <option value="Follow-up required" {% if review and review.recommendation == 'Follow-up required' %}selected{% endif %}>Follow-up Required</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="status">Review Status: <span style="color: red;">*</span></label>
                <select id="status" name="status" required>
                    <option value="Reviewed" {% if review and review.status == 'Reviewed' %}selected{% endif %}>Reviewed</option>
                    <option value="Monitoring" {% if review and review.status == 'Monitoring' %}selected{% endif %}>Monitoring</option>
                    <option value="Forwarded to Counselor" {% if review and review.status == 'Forwarded to Counselor' %}selected{% endif %}>Forward to Counselor</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-check"></i> Submit Review
            </button>
        </form>
    </div>
    {% else %}
    <div class="form-card">
        <p>Report not found.</p>
        <a href="{{ url_for('teacher.review_reports') }}" class="btn btn-primary">Back to Reports</a>
    </div>
    {% endif %}
</div>

<style>
.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-badge.status-reviewed {
    background-color: #D1FAE5;
    color: #065F46;
}

.status-badge.status-monitoring {
    background-color: #FEF3C7;
    color: #92400E;
}

.status-badge.status-forwarded-to-counselor {
    background-color: #DBEAFE;
    color: #1E40AF;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.badge-stage.badge-teacher-review {
    background-color: #FEF3C7;
    color: #92400E;
}

.badge-stage.badge-counselor-review {
    background-color: #DBEAFE;
    color: #1E40AF;
}

.badge-priority.badge-low {
    background-color: #E0E7FF;
    color: #3730A3;
}

.badge-priority.badge-normal {
    background-color: #DBEAFE;
    color: #1E40AF;
}

.badge-priority.badge-high {
    background-color: #FEE2E2;
    color: #991B1B;
}

.badge-priority.badge-critical {
    background-color: #FEE2E2;
    color: #7F1D1D;
    font-weight: 600;
}
</style>

<script>
document.getElementById('reviewForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        notes: document.getElementById('notes').value,
        action_taken: document.getElementById('action_taken').value || null,
        recommendation: document.getElementById('recommendation').value || null,
        status: document.getElementById('status').value
    };
    
    try {
        const response = await fetch('{{ url_for("teacher.review_report_detail", report_id=report.id) }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            const message = formData.status === 'Forwarded to Counselor' 
                ? 'Review submitted and report forwarded to counselor!'
                : 'Review submitted successfully!';
            
            if (typeof Toastify === 'function') {
                Toastify({
                    text: message,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#34C38F",
                }).showToast();
                setTimeout(() => {
                    window.location.replace('{{ url_for("teacher.review_reports") }}');
                }, 1500);
            } else {
                alert(message);
                window.location.replace('{{ url_for("teacher.review_reports") }}');
            }
        } else {
            const errorMsg = data.error || 'Failed to submit review';
            if (typeof Toastify === 'function') {
                Toastify({
                    text: errorMsg,
                    duration: 5000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#F44336",
                    close: true
                }).showToast();
            } else {
                alert(errorMsg);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        if (typeof Toastify === 'function') {
            Toastify({
                text: 'An error occurred. Please try again.',
                duration: 5000,
                gravity: "top",
                position: "right",
                backgroundColor: "#F44336",
                close: true
            }).showToast();
        } else {
            alert('An error occurred. Please try again.');
        }
    }
});
</script>
{% endblock %}

