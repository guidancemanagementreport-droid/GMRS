{% extends "dashboard_base.html" %}

{% block page_title %}Counseling Requests{% endblock %}

{% block content %}
<div class="container">
    <h1 style="margin-bottom: 1.5rem;">Counseling Requests</h1>
    
    {% if requests %}
    <div class="table-container" style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Report</th>
                    <th>Reason</th>
                    <th>Preferred Date</th>
                    <th>Urgency</th>
                    <th>Status</th>
                    <th>Date Requested</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for req in requests %}
                <tr>
                    <td>
                        {% if req.users %}
                            {{ (req.users.first_name or '') + ' ' + (req.users.last_name or '') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if req.student_reports %}
                            <strong>{{ req.student_reports.tracking_code or 'N/A' }}</strong><br>
                            <small>{{ req.student_reports.subject or 'N/A' }}</small>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">{{ req.reason[:100] }}{% if req.reason|length > 100 %}...{% endif %}</td>
                    <td>{{ req.preferred_date or 'N/A' }}</td>
                    <td><span class="badge badge-urgency badge-{{ req.urgency|lower }}">{{ req.urgency|title }}</span></td>
                    <td><span class="status-badge status-{{ req.status|lower }}">{{ req.status|title }}</span></td>
                    <td>
                        {% if req.created_at %}
                            {{ req.created_at[:10] if req.created_at|length > 10 else req.created_at }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if req.status == 'pending' %}
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-success" onclick="handleRequest('{{ req.id }}', 'approve')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="handleRequest('{{ req.id }}', 'reschedule')">
                                <i class="fas fa-calendar-alt"></i> Reschedule
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="handleRequest('{{ req.id }}', 'reject')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                        {% elif req.status == 'approved' or req.status == 'rescheduled' %}
                        <button class="btn btn-sm btn-primary" onclick="completeCounseling('{{ req.id }}')">
                            <i class="fas fa-check-circle"></i> Mark Completed
                        </button>
                        {% else %}
                        <span style="color: #9CA3AF;">{{ req.status|title }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem 1rem; color: #6B7280;">
        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
        <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No pending counseling requests</p>
        <p style="font-size: 0.9rem;">Counseling requests from students will appear here.</p>
    </div>
    {% endif %}
</div>

<!-- Modal for Approve/Reschedule -->
<div id="requestModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 id="modalTitle" style="margin-bottom: 1rem;"></h3>
        <form id="modalForm">
            <input type="hidden" id="modalRequestId">
            <input type="hidden" id="modalAction">
            <div class="form-group">
                <label for="modalScheduledDate">Scheduled Date & Time:</label>
                <input type="datetime-local" id="modalScheduledDate" class="form-control" required>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.data-table thead {
    background-color: #f8f9fa;
}

.data-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
}

.data-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    color: #4B5563;
}

.data-table tbody tr:hover {
    background-color: #f9fafb;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-badge.status-pending {
    background-color: #FEF3C7;
    color: #92400E;
}

.status-badge.status-approved {
    background-color: #D1FAE5;
    color: #065F46;
}

.status-badge.status-rescheduled {
    background-color: #DBEAFE;
    color: #1E40AF;
}

.status-badge.status-rejected {
    background-color: #FEE2E2;
    color: #991B1B;
}

.status-badge.status-completed {
    background-color: #E5E7EB;
    color: #374151;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.badge-urgency.badge-low {
    background-color: #E0E7FF;
    color: #3730A3;
}

.badge-urgency.badge-normal {
    background-color: #DBEAFE;
    color: #1E40AF;
}

.badge-urgency.badge-high {
    background-color: #FEE2E2;
    color: #991B1B;
}

.badge-urgency.badge-urgent {
    background-color: #FEE2E2;
    color: #7F1D1D;
    font-weight: 600;
}
</style>

<script>
let currentAction = '';

function handleRequest(requestId, action) {
    currentAction = action;
    document.getElementById('modalRequestId').value = requestId;
    document.getElementById('modalAction').value = action;
    
    if (action === 'approve') {
        document.getElementById('modalTitle').textContent = 'Approve Counseling Request';
    } else if (action === 'reschedule') {
        document.getElementById('modalTitle').textContent = 'Reschedule Counseling Request';
    } else if (action === 'reject') {
        if (confirm('Are you sure you want to reject this counseling request?')) {
            submitRequest(requestId, action, null);
        }
        return;
    }
    
    document.getElementById('requestModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('requestModal').style.display = 'none';
    document.getElementById('modalForm').reset();
}

document.getElementById('modalForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const requestId = document.getElementById('modalRequestId').value;
    const action = document.getElementById('modalAction').value;
    const scheduledDate = document.getElementById('modalScheduledDate').value;
    submitRequest(requestId, action, scheduledDate);
});

async function submitRequest(requestId, action, scheduledDate) {
    try {
        const response = await fetch('/counselor/counseling-requests', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                request_id: requestId,
                action: action,
                scheduled_date: scheduledDate
            })
        });
        
        const data = await response.json();
        if (data.success) {
            if (typeof Toastify === 'function') {
                Toastify({
                    text: data.message || 'Request updated successfully!',
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#34C38F",
                }).showToast();
            }
            closeModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(data.error || 'Failed to update request');
        }
    } catch (error) {
        if (typeof Toastify === 'function') {
            Toastify({
                text: error.message || 'An error occurred',
                duration: 5000,
                gravity: "top",
                position: "right",
                backgroundColor: "#F44336",
                close: true
            }).showToast();
        } else {
            alert(error.message || 'An error occurred');
        }
    }
}

async function completeCounseling(requestId) {
    if (!confirm('Mark this counseling session as completed? This will also settle the related report.')) {
        return;
    }
    
    try {
        const response = await fetch('/counselor/counseling-requests/' + requestId + '/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            if (typeof Toastify === 'function') {
                Toastify({
                    text: data.message || 'Counseling session completed and report settled!',
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#34C38F",
                }).showToast();
            }
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(data.error || 'Failed to complete counseling');
        }
    } catch (error) {
        if (typeof Toastify === 'function') {
            Toastify({
                text: error.message || 'An error occurred',
                duration: 5000,
                gravity: "top",
                position: "right",
                backgroundColor: "#F44336",
                close: true
            }).showToast();
        } else {
            alert(error.message || 'An error occurred');
        }
    }
}
</script>
{% endblock %}

